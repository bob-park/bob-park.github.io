---
title: "JPA ë¿Œì…”ë²„ë¦¬ê¸° - 2ë¶€"
categories:
  - Basic JPA
tags:
  - basic
  - JPA
date: 2021-12-11
last_modified_at: 2021-12-11
toc: true
toc_sticky: true
---

ì ì—¬ëŸ¬ë¶„ 2ë¶€ì…ë‹ˆë‹¤.

ì—´ì‹¬íˆ ì •ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ì‹¤ ì‚¬ìš©ê¹Œì§€ ê°€ë ¤ë©´ ì•„ì§ ë©€ì—ˆìŠµë‹ˆë‹¤. í˜ë‚´ì•¼í•©ë‹ˆë‹¤.ã…‹ã…‹ã…‹

ì´ì œëŠ” ì˜ˆì œ ì§ì ‘ í•œ ê±¸ ì •ë¦¬í•˜ê² ìŠµë‹ˆë‹¤.

# í™˜ê²½

## DB

### h2

- [h2](http://www.h2database.com/)
- ì‹¤ìŠµí•˜ê¸° ì•„ì£¼ ì¢‹ì€ DB
- ì—„ì²­ ê°€ë³ê³ 
- ì›¹ìš© Query Tool ì œê³µí•˜ê³ 
- MySQL, Oracle DB ì‹œë®¬ë ˆì´ì…˜ ê°€ëŠ¥í•˜ê³ 
- ë§ŒëŠ¥ì„

## Maven

- Java Library, Build Management
- Library ìë™ ë‹¤ìš´ë¡œë“œ ë° Dependency Management
- ìµœê·¼ì—ëŠ” Gradle ì´ ì ì  ì“´ë‹¤ê³ í•¨

<div class="notice--primary" markdown="1">
 â„¹ï¸ Gradle

- ì†”ì§íˆ Maven ë³´ë‹¤ ê°„ë‹¨í•˜ê³  ì“°ê¸° ì¢‹ì€ ë“¯
- ìƒˆë¡œ ë§Œë“œëŠ” í”„ë¡œì íŠ¸ëŠ” ë¬´ì¡°ê±´ Gradle ë¡œ í•˜ê³  ìˆìŒ
</div>

## Project êµ¬ì„±

### Java

- Java 8 ì´ìƒ ì‚¬ìš© ê¶Œì¥
  - ë‚˜ëŠ” Amazon Correcto openJDK 11 ì‚¬ìš©

### Library - pom.xml

```xml
<dependencies>
    <dependency>
        <groupId>org.hibernate</groupId>
        <artifactId>hibernate-entitymanager</artifactId>
        <version>5.5.5.Final</version>
    </dependency>

    <dependency>
        <groupId>com.h2database</groupId>
        <artifactId>h2</artifactId>
        <version>1.4.200</version>
    </dependency>
</dependencies>
```

<br>
<br>

# ì‹¤ìŠµí•´ì„œ ë¿Œì…”ë²„ë¦¬ê¸°

## JPA ì„¤ì •

### `persistence.xml`

- JPA ì„¤ì • íŒŒì¼
- ìœ„ì¹˜
  - `/META-INF/persistence.xml`  
    ![Alt ch02-01](/assets/images/basic-jpa/ch02-01.png "ìœ„ì¹˜")
- persistence-unit name ìœ¼ë¡œ ì´ë¦„ ì§€ì •
- javax.persistence ë¡œ ì‹œì‘ : JPA í‘œì¤€ ì†ì„±
- hibernate ë¡œ ì‹œì‘ : `Hibernate` ì „ìš© ì†ì„±

```xml
<?xml version="1.0" encoding="UTF-8"?>
<persistence version="2.2"
             xmlns="http://xmlns.jcp.org/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd">
    <persistence-unit name="hello">
        <properties>
            <!-- í•„ìˆ˜ ì†ì„± -->
            <property name="javax.persistence.jdbc.driver" value="org.h2.Driver"/>
            <property name="javax.persistence.jdbc.user" value="sa"/>
            <property name="javax.persistence.jdbc.password" value=""/>
            <property name="javax.persistence.jdbc.url" value="jdbc:h2:tcp://localhost/~/test"/>
            <property name="hibernate.dialect" value="org.hibernate.dialect.H2Dialect"/>
            <!-- ì˜µì…˜ -->
            <property name="hibernate.show_sql" value="true"/>
            <property name="hibernate.format_sql" value="true"/>
            <property name="hibernate.use_sql_comments" value="true"/>
            <property name="hibernate.jdbc.batch_size" value="10"/>
            <property name="hibernate.hbm2ddl.auto" value="create" />
        </properties>
    </persistence-unit>
</persistence>
```

## Database ë°©ì–¸(Dialect)

![Alt ch02-02](/assets/images/basic-jpa/ch02-02.png "Database Dialect")

- `JPA` ëŠ” íŠ¹ì • Database ì¢…ì† X
  - `Oracle` ì“°ë‹¤ê°€ `MySql` ë¡œ DB ê°€ ë³€ê²½ë˜ì—ˆì„ ê²½ìš°, `JPA` ì„¤ì • ì¤‘ Database ë°©ì–¸ë§Œ ë°”ê¿”ì£¼ë©´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
    - ë‹¨, DB ì— ì‚¬ìš©ì¤‘ì´ë˜ Custom Functionì„ `JPA` ì— ë“±ë¡í•´ì„œ ì‚¬ìš©ì¤‘ì¸ ê²½ìš° ì«Œ..ìˆ˜ì •ì´ í•„ìš”í• ë“¯
- ê° Database ê°€ ì œê³µí•˜ëŠ” SQL ë¬¸ë²•ê³¼ í•¨ìˆ˜ëŠ” ì¡°ê¸ˆì”© ë‹¤ë¦„
  - ê°€ë³€ë¬¸ì
    - `Oracle` : VARCHAR2
    - `MySQL` : VARCHAR
  - ë¬¸ìì—´ ìë¥´ëŠ” í•¨ìˆ˜
    - `ANSI SQL` : SUBSTRING()
    - `ORACLE` : SUBSTR()
  - Pagination
    - `Oralce` : ROWNUM
    - `MySQL` : LIMIT
- `Dialect` : `ANSI SQL` ì„ ì§€í‚¤ì§€ ì•ŠëŠ” íŠ¹ì • Database ë§Œì˜ ê³ ìœ í•œ ê¸°ëŠ¥

<div class="notice--primary" markdown="1">
 â„¹ï¸ `ANSI SQL`

- DBMS(Oracle, My-SQL, DB2 ë“±ë“±)ë“¤ì—ì„œ ê°ê¸° ë‹¤ë¥¸ SQLë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, ë¯¸êµ­ í‘œì¤€ í˜‘íšŒ(American National Standards Institute)ì—ì„œ ì´ë¥¼ í‘œì¤€í™”í•˜ì—¬ í‘œì¤€ SQLë¬¸ì„ ì •ë¦½ ì‹œì¼œ ë†“ì€ ê²ƒ

- íŠ¹ì§•
  - í‘œì¤€ SQLë¬¸ì´ê¸° ë•Œë¬¸ì— DBMSì˜ ì¢…ë¥˜ì— ì œì•½ì„ ë°›ì§€ ì•ŠìŒ
  - í…Œì´ë¸”ê°„ì˜ Join ê´€ê³„ê°€ FROM ì—ì„œ ëª…ì‹œë˜ê¸° ë•Œë¬¸ì— WHERE ë¬¸ì—ì„œ ì¡°ê±´ë§Œ í™•ì¸í•˜ë©´ ëœë‹¤.

</div>

### Database Dialect ì„¤ì •

- hibernate.dialect ì†ì„±ì— ì§€ì •

  - `H2` : org.hibernate.dialect.H2Dialect
  - `Oracle` : org.hibernate.dialect.Oracle10gDialect
  - `MySQL` : org.hibernate.dialect.MySQL5InnoDBDialect

- `Hibernate` ëŠ” 40ê°€ì§€ ì´ìƒì˜ Database Dialect ì§€ì›

## JPA êµ¬ë™ ë°©ì‹

![Alt ch02-03](/assets/images/basic-jpa/ch02-03.png "JPA êµ¬ë™ ë°©ì‹")

## ê°ì²´ì™€ í…Œì´ë¸”ì„ ìƒì„±í•˜ê³  ë§µí•‘í•˜ê¸°

- `@Entity` : JPA ê°€ ê´€ë¦¬í•  ê°ì²´
- `@ID` : Database Table ì˜ ê¸°ë³¸í‚¤(PK) ì™€ ë§µí•‘

```java
@Entity
public class Member {

    @Id
    @GeneratedValue
    private Long id;
}

```

## ì‹¤ìŠµí•´ë³´ì

<div class="notice--primary" markdown="1">
âš ï¸ ì£¼ì˜ì‚¬í•­

- `EntityManagerFactory` ëŠ” í•˜ë‚˜ë§Œ ìƒì„±í•´ì„œ Application ì „ì²´ì—ì„œ ê³µìœ 
- `EntityManager` ëŠ” Thread ê°„ ê³µìœ  X (ì‚¬ìš©í•˜ê³  ë²„ë ¤ì•¼ í•œë‹¤.)
- `JPA` ì˜ ëª¨ë“  ë°ì´í„° ë³€ê²½ì€ `Transaction` ì•ˆì—ì„œ ì‹¤í–‰
</div>

### `EntityManagerFactory`

```java
EntityManagerFactory emf = Persistence.createEntityManagerFactory("hello");
```

- DB ë‹¹ 1ê°œë§Œ ìƒì„±ë¨
- Container ê°€ ìƒì„± ì‹œì ì— ìƒì„±ë¨

### `EntityManager`

```java
EntityManager em = emf.createEntityManager();
```

- `Transaction` ë‹¨ìœ„ ë˜ëŠ” ì‘ì—… ë‹¨ìœ„ë§ˆë‹¤ `EntityManager` ë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

### `EntityTransaction`

```java
EntityTransaction tx = em.getTransaction();
```

- `JPA` ì˜ ëª¨ë“  ë³€ê²½ì‚¬í•­ì€ `Transaction` ì•ˆì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•œë‹¤.

### ê¸°ë³¸ ì½”ë“œ

```java
// EntityManagerFactory ìƒì„±
EntityManagerFactory emf = Persistence.createEntityManagerFactory("hello");

// EntityManagerFactory ì—ì„œ EntityManager ìƒì„±
EntityManager em = emf.createEntityManager();

// EntityManager ì—ì„œ Transaction ê°€ì ¸ì˜¤ê¸°
EntityTransaction tx = em.getTransaction();

tx.begin(); // Transaction ì‹œì‘

try {

    Member member = new Member();
    member.setUsername("memberA");

    em.persist(member);

} catch(Exception e){
    tx.rollback(); // rollback
} finally {
    em.close(); // ì‚¬ìš© í›„ ë°˜ë“œì‹œ ë‹«ì•„ì£¼ì–´ì•¼ í•œë‹¤.
}

emf.close(); // ì‚¬ìš© í›„ ë°˜ë“œì‹œ ë‹«ì•„ì£¼ì–´ì•¼ í•œë‹¤.

```

# JPQL

- ê°€ì¥ ë‹¨ìˆœí•œ ì¡°íšŒ ë°©ë²•
  ```java
  em.find(Member.class, 1);
  ```

<div class="notice--primary" markdown="1">
â„¹ï¸ ê·¸ë ‡ë‹¤ë©´, ë‚˜ì´ê°€ 18ì‚´ ì´ìƒì¸ íšŒì›ì„ ëª¨ë‘ ê²€ìƒ‰í•˜ê³  ì‹¶ë‹¤ë©´?

- ê°€ì¥ ë‹¨ìˆœí•œ ì¡°íšŒ ë°©ë²•ì€ PK ë¡œ ë°–ì— ê²€ìƒ‰ì´ ë˜ì§€ ì•Šì•„ ë¶ˆê°€ëŠ¥
- ì´ë–„, JPQL ì‚¬ìš©í•˜ì—¬ PK ê°€ ì•„ë‹Œ ì¡°ê±´ìœ¼ë¡œ ì¡°íšŒí•˜ê±°ë‚˜, ë” ë³µì¡í•œ ì¡°ê±´ìœ¼ë¡œ ì¡°íšŒê°€ ê°€ëŠ¥
</div>

## ì‹¤ìŠµ

### JPQL ì‚¬ìš©í•˜ê¸°

- ì „ì²´ íšŒì› ê²€ìƒ‰
  ```java
  List<Member> resultList = em.createQuery("select m from Member", Member.class).getResultList();
  ```
- ID ê°€ 2 ì´ìƒì¸ íšŒì› ê²€ìƒ‰
  ```java
  List<Member> resultList = em.createQuery("select m from Member where id >= 2", Member.class).getResultList();
  ```

## JPQL ì´ ë“±ì¥í•œ ë°°ê²½

- `JPA` ë¥¼ ì‚¬ìš©í•˜ë©´ `Entity` ê°ì²´ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ê°œë°œ
- ë¬¸ì œëŠ” ê²€ìƒ‰ ì¿¼ë¦¬
- ê²€ìƒ‰í• ë–„ë„ í…Œì´ë¸”ì´ ì•„ë‹Œ `Entity` ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ê²€ìƒ‰
- ëª¨ë“  DB ë°ì´í„°ë¥¼ ê°ì²´ë¡œ ë³€í™˜í•´ì„œ ê²€ìƒ‰í•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥
- Application ì´ í•„ìš”í•œ ë°ì´í„°ë§Œ DB ì—ì„œ ë¶ˆëŸ¬ì˜¤ë ¤ë©´, ê²°êµ­ ê²€ìƒ‰ì¡°ê±´ì´ í¬í•¨ëœ SQL í•„ìš”

## JPQL íŠ¹ì§•

- `JPA` ëŠ” SQL ì„ ì¶”ìƒí™”í•œ JPQL ì´ë¼ëŠ” ê°ì²´ ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´ ì œê³µ
- SQLê³¼ ë¬¸ë²• ìœ ì‚¬
  - SELECT, FROM, WHERE, GROUP BY, HAVING, JOIN ì§€ì›
- **JPQL ì€ `Entity` ê°ì²´**ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬
- **SQL ì€ Database Table**ì„ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬
- í…Œì´ë¸”ì´ ì•„ë‹Œ **ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ê²€ìƒ‰í•˜ëŠ” ê°ì²´ ì§€í–¥ ì¿¼ë¦¬**
- SQL ì„ ì¶”ìƒí™”í•´ì„œ íŠ¹ì • Database SQL ì˜ì¡´ X
- JPQL ì„ í•œë§ˆë””ë¡œ ì •ì˜í•˜ë©´ ê°ì²´ ì§€í–¥ SQL

<div class="notice--primary" markdown="1">
ğŸ‘ ìì„¸í•œ JPQL ë‚´ìš©ì€ ë‚˜ì¤‘ì— ë‹¤ë£¨ê² ìŒ
</div>
